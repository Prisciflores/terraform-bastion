name: Bastion Infra + Ansible Bootstrap  # ðŸ§¾ Nombre visible del workflow en GitHub

# ðŸ” Este workflow se dispara manualmente desde la interfaz de GitHub
on:
  workflow_dispatch:
    inputs:
      action:
        description: 'AcciÃ³n a ejecutar (apply o destroy)'  # ðŸ“ Input manual
        required: true
        default: 'apply'
        type: choice
        options:
          - apply
          - destroy  # ðŸ”¨ Puedes elegir aplicar o destruir la infraestructura

# ðŸ” Permisos mÃ­nimos requeridos por GitHub Actions (necesario para environments)
permissions:
  issues: write           # âœ… Solo si usas issues (en este caso, no es obligatorio)
  id-token: write         # ðŸ“› Requerido para autenticaciÃ³n de algunos servicios
  contents: read          # ðŸ“„ Para poder leer del repo

# ðŸŒŽ Variables de entorno generales, accesibles en todos los jobs
env:
  TF_WORKING_DIR: ./                            # ðŸ“ Ruta del cÃ³digo Terraform
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}        # ðŸ” Credencial AWS
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}# ðŸ” Credencial AWS
  AWS_DEFAULT_REGION: "us-east-1"              # ðŸŒ RegiÃ³n por defecto de AWS

jobs:
  terraform:
    name: Terraform Plan & Apply               # ðŸ”§ Job principal para IaC
    runs-on: ubuntu-latest                     # ðŸ–¥ï¸ Ejecutado en runner de Ubuntu
    environment: production                    # âœ… Usa environment con aprobaciÃ³n manual

    # ðŸ“¤ Define outputs del job para pasarlos a otros jobs (ej: IP bastiÃ³n)
    outputs:
      bastion_ip: ${{ steps.bastion_ip.outputs.ip }}

    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}  # ðŸ“‚ Aplica en todos los steps

    steps:
      # ðŸ”„ Clona el repositorio
      - name: Checkout repo
        uses: actions/checkout@v3

      # âš™ï¸ Instala Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7

      # ðŸ§± Inicializa Terraform
      - name: Terraform Init
        run: terraform init

      # ðŸŽ¨ Verifica formato del cÃ³digo
      - name: Terraform Format
        run: terraform fmt -check

      # âœ… Valida sintaxis de los archivos `.tf`
      - name: Terraform Validate
        run: terraform validate

      # ðŸ” Planifica los cambios en la infraestructura
      - name: Terraform Plan
        run: terraform plan -var-file="terraform.tfvars"

      # ðŸŸ¢ Aplica los cambios si se eligiÃ³ 'apply'
      - name: Terraform Apply
        if: github.event.inputs.action == 'apply'
        run: terraform apply -auto-approve -var-file="terraform.tfvars"

      # ðŸ”´ Destruye la infraestructura si se eligiÃ³ 'destroy'
      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        run: terraform destroy -auto-approve -var-file="terraform.tfvars"

      # ðŸŒ Extrae la IP pÃºblica de la instancia bastiÃ³n
      - name: Get Bastion IP
        if: github.event.inputs.action == 'apply'
        id: bastion_ip
        run: |
          IP=$(terraform output -raw bastion_public_ip)
          echo "ip=$IP" >> "$GITHUB_OUTPUT"  # ðŸ“¤ Exporta la IP como output del step

  ansible:
    name: Ansible Bootstrap                     # ðŸ¤– Job para aprovisionar con Ansible
    needs: terraform                            # â³ Se ejecuta despuÃ©s del job anterior
    if: github.event.inputs.action == 'apply'   # Solo si se eligiÃ³ 'apply'
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./ansible-bootstrap/playbooks  # ðŸ“‚ Donde estÃ¡ bootstrap.yml

    steps:
      # ðŸ”„ Clona el repositorio
      - name: Checkout repo
        uses: actions/checkout@v3

      # ðŸ§° Instala Ansible
      - name: Install Ansible
        run: sudo apt-get update && sudo apt-get install -y ansible

      # ðŸ‘€ Muestra la IP del bastiÃ³n obtenida del job anterior
      - name: Show Bastion IP
        run: |
          TARGET_IP=${{ needs.terraform.outputs.bastion_ip }}
          echo "Target: $TARGET_IP"

      # ðŸ” Crea la clave SSH desde el Secret
      - name: Crear clave privada desde secret
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/priscila-key.pem
          chmod 600 ~/.ssh/priscila-key.pem

      # ðŸ“„ Genera un archivo de inventario con la IP del bastiÃ³n
      - name: Generar archivo de inventario
        run: |
          echo "[bastion]
          ${{ needs.terraform.outputs.bastion_ip }} ansible_user=ec2-user ansible_ssh_private_key_file=~/.ssh/priscila-key.pem" > inventory/hosts

      # ðŸš€ Ejecuta el playbook de Ansible para configurar la instancia
      - name: Ejecutar playbook
        run: ansible-playbook -i inventory/hosts bootstrap.yml
